##
# Runs sanity tests on the core and the sample kernels.
##

steps:
##
# The conda task is deprecated, so conda must be used inline.
##
- pwsh: |
    $(CONDA)/scripts/conda.exe create --yes --quiet --name core_tests
  displayName: Create Anaconda environment

- script: |
    $(CONDA)/scripts/conda.exe install --yes --quiet --name core_tests python=3.8 notebook jupyter_client pytest nose pip>=18.1
  displayName: Install Anaconda packages

##
# Conda must be activated for every subsequent task.
# The first line will execute shell functions that are dynamcally generated by conda and are a substitute for conda init.
##
- pwsh: |
    (& "C:\Miniconda\scripts\conda.exe" "shell.powershell" "hook") | Out-String | Invoke-Expression
    conda activate core_tests
    conda info
    pip list
    pip install git+https://github.com/IsraelMiles/jupyter_kernel_test.git
  displayName: 'Install additional dependencies from pip'

# The version of pyzmq on Anaconda does not seem to work in Windows agents
# as of November 2018: https://github.com/zeromq/pyzmq/issues/852
- pwsh: |
    (& "C:\Miniconda\scripts\conda.exe" "shell.powershell" "hook") | Out-String | Invoke-Expression
    conda activate core_tests
    pip uninstall -y pyzmq
    pip install pyzmq
  displayName: 'Fix pyzmq on Windows'
  condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'))

- pwsh: |
    (& "C:\Miniconda\scripts\conda.exe" "shell.powershell" "hook") | Out-String | Invoke-Expression
    conda activate core_tests
    dotnet run -c $(Build.Configuration) -v n -- install --develop
  displayName: "Add IEcho kernel to Jupyter."
  workingDirectory: examples/echo-kernel

- pwsh: |
    (& "C:\Miniconda\scripts\conda.exe" "shell.powershell" "hook") | Out-String | Invoke-Expression
    conda activate core_tests
    dotnet run -c $(Build.Configuration) -v n -- install --develop
  displayName: "Add IMoon kernel to Jupyter."
  workingDirectory: examples/moon-kernel

- pwsh: |
    (& "C:\Miniconda\scripts\conda.exe" "shell.powershell" "hook") | Out-String | Invoke-Expression
    conda activate core_tests
    py.test tests/protocol/
  displayName: "Run Jupyter protocol tests."
  workingDirectory: .

